<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ron R Togunov, Philip Mostert, Bob O’Hara">
<meta name="dcterms.date" content="2024-07-12">

<title>Multispecies Integrated Species Distribution Modeling Workshop</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="SetophagaExercise3_files/libs/clipboard/clipboard.min.js"></script>
<script src="SetophagaExercise3_files/libs/quarto-html/quarto.js"></script>
<script src="SetophagaExercise3_files/libs/quarto-html/popper.min.js"></script>
<script src="SetophagaExercise3_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="SetophagaExercise3_files/libs/quarto-html/anchor.min.js"></script>
<link href="SetophagaExercise3_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="SetophagaExercise3_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="SetophagaExercise3_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="SetophagaExercise3_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="SetophagaExercise3_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Multispecies Integrated Species Distribution Modeling Workshop</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ron R Togunov, Philip Mostert, Bob O’Hara </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 12, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Multispecies integrated Species Distribution Models (iSDMs) offer powerful tools for ecological analysis. These models allow us to simultaneously analyze multiple species, potentially improving our understanding of species distributions and the factors that influence them. By default, these models share range, standard deviation, and precision parameters across species, which can lead to more robust estimates, especially for rare species or those with limited data. Additionally, this approach can help in correcting for sampling bias, a common issue in ecological data collection.</p>
<p>This workshop aims to guide you through the process of setting up and interpreting multispecies iSDMs using the <code>PointedSDMs</code> package. We’ll explore various modeling approaches and discuss their ecological implications.</p>
</section>
<section id="setophaga-example" class="level1">
<h1><em>Setophaga</em> example</h1>
<section id="data-preparations" class="level2">
<h2 class="anchored" data-anchor-id="data-preparations">Data Preparations</h2>
<p>We will use the same data as in the previous vignette with three species (<em>Setophaga fusca</em>, <em>Setophaga caerulescens</em>, and <em>Setophaga magnolia</em>) obtained from three datasets (eBird, BBS, and BBA) as well as two covariates (elevation and canopy cover).</p>
<p>First, let’s load the required packages and prepare our data:</p>
<p>To speed things up for the workshop, we will model just two of the three species.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>SetophagaData <span class="ot">&lt;-</span> <span class="fu">map</span>(SetophagaData_full, \(.x) <span class="fu">filter</span>(.x, Species_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Setophaga_caerulescens"</span>, <span class="st">"Setophaga_magnolia"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="building-the-multispecies-model" class="level2">
<h2 class="anchored" data-anchor-id="building-the-multispecies-model">Building the Multispecies Model</h2>
<p>Now that we’ve prepared our data, we’re ready to set up our multispecies model. One of the key decisions we have to make is in what information is shared across species (i.e., what parameters are shared among the species). Specifically, if our species <span class="math inline">\(i\)</span> intensity field <span class="math inline">\(\lambda_s(\bf{s})\)</span> is defined as:</p>
<p><span class="math display">\[
\lambda_i(\bf{s}) = \alpha_i + \zeta_i(\bf{s}) \\
\zeta_i(\bf{s}) \sim N(0, \sigma_i^2),
\]</span></p>
<p>where <span class="math inline">\(\zeta_i(\bf{s})\)</span> is a species level spatial effect with covariance matrix <span class="math inline">\(\sigma^2_i\)</span>. We can share information in 3 ways using the argument <code>speciesSpatial</code>:</p>
<ul>
<li><strong><code>"share"</code></strong> share everything: <span class="math inline">\(\zeta_i(\bf{s}) = \zeta(\bf{s})\)</span>, in which the random field is the same across all species.</li>
<li><strong><code>"replicate"</code></strong> share only the hyper-parameters: <span class="math inline">\(\sigma_i^2 = \sigma^2\)</span>, in which the intensities of the random field are different but the hyperparameters (i.e., range and sigma) are different.</li>
<li><strong><code>"copy"</code></strong> share nothing: <span class="math inline">\(\zeta_i(\bf{s})\)</span> and <span class="math inline">\(\sigma_i^2\)</span> are all different, in which the both the intensities and the hyperparameters are independent across species.</li>
</ul>
<section id="shared-spatial-effect-speciesspatial-shared" class="level3">
<h3 class="anchored" data-anchor-id="shared-spatial-effect-speciesspatial-shared">Shared spatial effect: <code>speciesSpatial = "shared"</code></h3>
<p>We use the <code>startSpecies()</code> to initialise the multispecies ISDM. Many of the arguments are the same as in the <code>startISDM()</code> we used in the previous vignette. Additional arguments include: <code>speciesIntercept</code> to control the intercept for the species, <code>speciesEnvironment</code> to control the environmental effects for the species (species-specific effects or shared across species), and <code>speciesSpatial</code> to control what information in the spatial effect is shared across species.</p>
<p>The simplest model we can construct assumes that all species occurrence emerge from a common distribution. This is achieved by defining the <code>speciesSpatial</code> argument as <code>"shared"</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>speciesModelShared <span class="ot">&lt;-</span> <span class="fu">startSpecies</span>(SetophagaData, <span class="at">Boundary =</span> PA, </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">Projection =</span> proj, <span class="at">Mesh =</span> mesh,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">responsePA =</span> <span class="st">'NPres'</span>, </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">trialsPA =</span> <span class="st">'Trials'</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">spatialCovariates =</span> covariates, </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">speciesName =</span> <span class="st">'Species_name'</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">pointsSpatial =</span> <span class="cn">NULL</span>, <span class="co"># Do not include a dataset spatial field</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">speciesSpatial =</span> <span class="st">"shared"</span>)   <span class="co"># unique spatial field per species</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ve also set <code>pointsSpatial = NULL</code> to simplify the model by not including dataset-specific spatial effects.</p>
<section id="model-specification" class="level4">
<h4 class="anchored" data-anchor-id="model-specification">Model Specification</h4>
<p>Again, the output of <code>speciesSpatial()</code> is an <em>R6</em> object, for which we can use the <code>?.$help()</code> slot function to view the other available slot functions and their documentation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>speciesModelShared<span class="sc">$</span><span class="fu">help</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plotting the multispecies model, shows the distribution by species rather than by dataset as in the previous vignette.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>speciesModelShared<span class="sc">$</span><span class="fu">plot</span>() <span class="sc">+</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">'Plot of the species'</span>) <span class="sc">+</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/dataset%20plot-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>The resulting plot shows the distribution of observations for each species. This gives us a first look at the data and can help identify potential sampling biases or differences in species ranges.</p>
<p>As in the single-species model from the previous vignette, we can specify the priors for the fixed and random effects using <code>.$specifySpatial</code> , <code>.$priorsFixed</code> and <code>.$specifyRandom</code>. In <code>.$specifyRandom</code>, the argument <code>speciesGroup</code> is used to change the prior for the precision (inverse variance) of group model for the spatial effects, and <code>speciesIntercepts</code> is used to change the prior for the precision for the random intercept term. For both of these parameters, we choose <em>pc priors.</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hyper parameters of the spatial field (shared across species)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>speciesModelShared<span class="sc">$</span><span class="fu">specifySpatial</span>(<span class="at">Species =</span> <span class="cn">TRUE</span>,  <span class="co"># define same prior for the all species</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.1</span>),  <span class="co"># SD of field variation; P(σ &gt; σ0)</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="fl">0.1</span>))  <span class="co"># range of spatial correlation; P(ρ &lt; ρ0)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># prior for intercept of datasets (common for all datasets and all species in the model)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>speciesModelShared<span class="sc">$</span><span class="fu">priorsFixed</span>(<span class="at">Effect =</span> <span class="st">'Intercept'</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mean.linear =</span> <span class="dv">0</span>, </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">prec.linear =</span> <span class="fl">0.1</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># prior for random effects (mesh nodes of spatial field and species intercepts)</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>speciesModelShared<span class="sc">$</span><span class="fu">specifyRandom</span>(</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision parameter on how much each species' spatial field (how much they can deviate from the shared ___)</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">speciesGroup =</span> <span class="fu">list</span>(<span class="at">model =</span> <span class="st">"iid"</span>, </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">prior =</span> <span class="st">"pc.prec"</span>,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">param =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>)))),  <span class="co"># P(σ &gt; σ0)</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision parameter on the baseline species occurrence rate</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">speciesIntercepts =</span> <span class="fu">list</span>(<span class="at">prior =</span> <span class="st">'pc.prec'</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>                           <span class="at">param =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>)))  <span class="co"># P(σ &gt; σ0)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can specify model options and fit the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>modelOptions <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">control.inla =</span> <span class="fu">list</span>(<span class="at">int.strategy =</span> <span class="st">'eb'</span>, <span class="at">diagonal =</span> <span class="fl">0.1</span>, <span class="at">cmin =</span> <span class="dv">0</span>), </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">safe =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Species-specific spatial effects model</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>speciesSharedEst <span class="ot">&lt;-</span> <span class="fu">fitISDM</span>(<span class="at">data =</span> speciesModelShared, <span class="at">options =</span> modelOptions)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># View summary of the estimated model</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(speciesSharedEst)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Summary of 'modSpecies' object:

inlabru version: 2.11.1
INLA version: 24.05.10

Types of data modelled:
                                    
eBird                   Present only
BBA                  Present absence
BBS                  Present absence

Summary of the fixed effects for the species:

Summary for Setophaga_caerulescens:
                                               mean         sd 0.025quant
Setophaga_caerulescens_elevation         0.25603969 0.04215623  0.1734150
Setophaga_caerulescens_canopy            0.26826306 0.03094258  0.2076167
Setophaga_caerulescens_random_intercept -0.07750652 0.01191055 -0.1008508
                                           0.5quant  0.975quant        mode kld
Setophaga_caerulescens_elevation         0.25603969  0.33866438  0.25603969   0
Setophaga_caerulescens_canopy            0.26826306  0.32890941  0.26826306   0
Setophaga_caerulescens_random_intercept -0.07750652 -0.05416227 -0.07750652   0

Summary for Setophaga_magnolia:
                                          mean         sd 0.025quant   0.5quant
Setophaga_magnolia_elevation        0.34058622 0.04308344 0.25614423 0.34058622
Setophaga_magnolia_canopy           0.22407099 0.02941232 0.16642390 0.22407099
Setophaga_magnolia_random_intercept 0.07750661 0.01191055 0.05416236 0.07750661
                                    0.975quant       mode kld
Setophaga_magnolia_elevation         0.4250282 0.34058622   0
Setophaga_magnolia_canopy            0.2817181 0.22407099   0
Setophaga_magnolia_random_intercept  0.1008509 0.07750661   0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Time used:
    Pre = 0.774, Running = 1.6, Post = 0.11, Total = 2.48 
Random effects:
  Name    Model
    speciesShared SPDE2 model
   Species_name_intercepts IID model

Model hyperparameters:
                                        mean      sd 0.025quant 0.5quant
Range for speciesShared                86.57  13.506     63.962    85.24
Stdev for speciesShared                 1.09   0.087      0.938     1.09
Precision for Species_name_intercepts 180.50 123.258     49.031   148.22
                                      0.975quant   mode
Range for speciesShared                   116.98  82.09
Stdev for speciesShared                     1.28   1.08
Precision for Species_name_intercepts     507.04 103.20

Deviance Information Criterion (DIC) ...............: -95628.03
Deviance Information Criterion (DIC, saturated) ....: NA
Effective number of parameters .....................: -106835.00

Watanabe-Akaike information criterion (WAIC) ...: 30771.76
Effective number of parameters .................: 9388.28

Marginal log-Likelihood:  -59399.13 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
</section>
<section id="examining-species-specific-responses" class="level4">
<h4 class="anchored" data-anchor-id="examining-species-specific-responses">Examining Species-Specific Responses</h4>
<p>Let’s look at how different species respond to environmental covariates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract fixed effects</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>fixed_effects <span class="ot">&lt;-</span> speciesSharedEst<span class="sc">$</span>summary.fixed</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot species-specific responses to elevation</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fixed_effects[<span class="fu">grep</span>(<span class="st">"elevation"</span>, <span class="fu">rownames</span>(fixed_effects)),], </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">rownames</span>(fixed_effects)[<span class="fu">grep</span>(<span class="st">"elevation"</span>, <span class="fu">rownames</span>(fixed_effects))], </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> mean, <span class="at">ymin =</span> <span class="st">`</span><span class="at">0.025quant</span><span class="st">`</span>, <span class="at">ymax =</span> <span class="st">`</span><span class="at">0.975quant</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>() <span class="sc">+</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Species"</span>, <span class="at">y =</span> <span class="st">"Effect of Elevation"</span>, </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Species-Specific Responses to Elevation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/shared%20mod%20plot%20cov%20est-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can plot the predict and plot the spatial field Predictions as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>speciesSharedPredSpat <span class="ot">&lt;-</span> <span class="fu">predict</span>(speciesSharedEst,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">data =</span> <span class="fu">fm_pixels</span>(<span class="at">mesh =</span> mesh,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">mask =</span> PA),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">spatial =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">n.samples =</span> <span class="dv">100</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(speciesSharedPredSpat, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">'mean'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/shared%20mod%20pred%20spat-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The covariate effects can also be plotted separately as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>speciesSharedPredCov <span class="ot">&lt;-</span> <span class="fu">predict</span>(speciesSharedEst,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">data =</span> <span class="fu">fm_pixels</span>(<span class="at">mesh =</span> mesh,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                                                 <span class="at">mask =</span> PA),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">spatial =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">covariates =</span> speciesSharedEst<span class="sc">$</span>spatCovs<span class="sc">$</span>name,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                                <span class="at">n.samples =</span> <span class="dv">100</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(speciesSharedPredCov, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">'mean'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/shared%20mod%20pred%20cov-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Alternatively, we can predict the spatial and covariate effects together as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>speciesSharedPredSpatCov <span class="ot">&lt;-</span> <span class="fu">predict</span>(speciesSharedEst,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">data =</span> <span class="fu">fm_pixels</span>(<span class="at">mesh =</span> mesh,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">mask =</span> PA),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">predictor =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">n.samples =</span> <span class="dv">100</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># # or equivalently:</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># speciesSharedPredSpatCov &lt;- predict(speciesSharedEst,</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#                               data = fm_pixels(mesh = mesh,</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                mask = PA),</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                               spatial = TRUE,</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">#                               covariates = speciesSharedEst$spatCovs$name,</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">#                               n.samples = 100)</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(speciesSharedPredSpatCov, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">'mean'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/shared%20mod%20pred%20spatCov-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This shared approach can be particularly useful when species are expected to respond similarly to underlying environmental gradients, or when data for some species is limited. It is also computationally the fastest as there are fewer parameters being estimated.</p>
</section>
</section>
<section id="shared-hyperparameters-speciesspatial-replicate" class="level3">
<h3 class="anchored" data-anchor-id="shared-hyperparameters-speciesspatial-replicate">Shared hyperparameters: <code>speciesSpatial = "replicate"</code></h3>
<p>The next up is allowing each species to have their own spatial fields and intercepts, but share their hyperparameters (i.e., range and sigma). We achieve this by defining the <code>speciesSpatial</code> argument as <code>replicate</code>. This also happens to be the default for <code>startSpecies()</code> (i.e., when <code>speciesSpatial</code> is not explicitly defined). This approach allows for species-specific spatial patterns while still borrowing strength across species regarding the structural heterogeneity in the spatial field.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>speciesModelReplicate <span class="ot">&lt;-</span> <span class="fu">startSpecies</span>(SetophagaData, <span class="at">Boundary =</span> PA, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">Projection =</span> proj, <span class="at">Mesh =</span> mesh,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">responsePA =</span> <span class="st">'NPres'</span>, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">trialsPA =</span> <span class="st">'Trials'</span>, </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">spatialCovariates =</span> covariates, </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">speciesName =</span> <span class="st">'Species_name'</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">pointsSpatial =</span> <span class="cn">NULL</span>, <span class="co"># Do not include a dataset spatial field</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">speciesSpatial =</span> <span class="st">"replicate"</span>)  <span class="co"># unique spatial field per species</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Specify priors for spatial and random effects:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hyper parameters of the spatial field (shared across species)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>speciesModelReplicate<span class="sc">$</span><span class="fu">specifySpatial</span>(<span class="at">Species =</span> <span class="cn">TRUE</span>,  <span class="co"># define same prior for the all species</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.1</span>),  <span class="co"># SD of field variation; P(σ &gt; σ0)</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="fl">0.1</span>))  <span class="co"># range of spatial correlation; P(ρ &lt; ρ0)</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># prior for intercept of datasets (common for all datasets and all species in the model)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>speciesModelReplicate<span class="sc">$</span><span class="fu">priorsFixed</span>(<span class="at">Effect =</span> <span class="st">'Intercept'</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">mean.linear =</span> <span class="dv">0</span>, </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">prec.linear =</span> <span class="fl">0.1</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># prior for random effects (mesh nodes of spatial field and species intercepts)</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>speciesModelReplicate<span class="sc">$</span><span class="fu">specifyRandom</span>(</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision parameter on how much each species' spatial field (how much they can deviate from the shared ___)</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">speciesGroup =</span> <span class="fu">list</span>(<span class="at">model =</span> <span class="st">"iid"</span>, </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">prior =</span> <span class="st">"pc.prec"</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">param =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>)))),  <span class="co"># P(σ &gt; σ0)</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision parameter on the baseline species occurrence rate</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">speciesIntercepts =</span> <span class="fu">list</span>(<span class="at">prior =</span> <span class="st">'pc.prec'</span>,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>                           <span class="at">param =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>)))  <span class="co"># P(σ &gt; σ0)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can specify model options and fit the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Species-specific spatial effects model</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>speciesReplicateEst <span class="ot">&lt;-</span> <span class="fu">fitISDM</span>(<span class="at">data =</span> speciesModelReplicate, <span class="at">options =</span> modelOptions)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># View summary of the estimated model</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(speciesReplicateEst)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Summary of 'modSpecies' object:

inlabru version: 2.11.1
INLA version: 24.05.10

Types of data modelled:
                                    
eBird                   Present only
BBA                  Present absence
BBS                  Present absence

Summary of the fixed effects for the species:

Summary for Setophaga_caerulescens:
                                                mean         sd  0.025quant
Setophaga_caerulescens_elevation         0.606325688 0.05149611  0.50539517
Setophaga_caerulescens_canopy            0.424485483 0.04146223  0.34322100
Setophaga_caerulescens_random_intercept -0.001677883 0.02939883 -0.05929854
                                            0.5quant 0.975quant         mode
Setophaga_caerulescens_elevation         0.606325688 0.70725621  0.606325688
Setophaga_caerulescens_canopy            0.424485483 0.50574997  0.424485483
Setophaga_caerulescens_random_intercept -0.001677883 0.05594277 -0.001677883
                                        kld
Setophaga_caerulescens_elevation          0
Setophaga_caerulescens_canopy             0
Setophaga_caerulescens_random_intercept   0

Summary for Setophaga_magnolia:
                                            mean         sd  0.025quant
Setophaga_magnolia_elevation        -0.203927669 0.05896734 -0.31950154
Setophaga_magnolia_canopy            0.054859718 0.03338982 -0.01058312
Setophaga_magnolia_random_intercept  0.001678079 0.02939883 -0.05594257
                                        0.5quant  0.975quant         mode kld
Setophaga_magnolia_elevation        -0.203927669 -0.08835380 -0.203927669   0
Setophaga_magnolia_canopy            0.054859718  0.12030255  0.054859718   0
Setophaga_magnolia_random_intercept  0.001678079  0.05929873  0.001678079   0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Time used:
    Pre = 0.664, Running = 2.18, Post = 0.107, Total = 2.95 
Random effects:
  Name    Model
    speciesShared SPDE2 model
   Species_name_intercepts IID model

Model hyperparameters:
                                        mean     sd 0.025quant 0.5quant
Range for speciesShared                87.34  10.00      69.69    86.64
Stdev for speciesShared                 1.15   0.07       1.02     1.15
Precision for Species_name_intercepts 904.35 978.04     131.21   615.56
                                      0.975quant   mode
Range for speciesShared                   109.00  85.02
Stdev for speciesShared                     1.30   1.14
Precision for Species_name_intercepts    3468.88 315.38

Deviance Information Criterion (DIC) ...............: -97462.29
Deviance Information Criterion (DIC, saturated) ....: NA
Effective number of parameters .....................: -107498.58

Watanabe-Akaike information criterion (WAIC) ...: 32357.71
Effective number of parameters .................: 10459.77

Marginal log-Likelihood:  -59381.02 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<p>We can predict and plot the spatial field Predictions as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>speciesReplicatePredSpat <span class="ot">&lt;-</span> <span class="fu">predict</span>(speciesReplicateEst,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">data =</span> <span class="fu">fm_pixels</span>(<span class="at">mesh =</span> mesh,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">mask =</span> PA),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">spatial =</span> <span class="cn">TRUE</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">n.samples =</span> <span class="dv">100</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(speciesReplicatePredSpat, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">'mean'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/replicate%20mod%20pred%20spat-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As we are primarily changing the structure of the spatial field, we will not plot covariate effects for this example.</p>
</section>
<section id="independent-spatial-field-speciesspatial-copy" class="level3">
<h3 class="anchored" data-anchor-id="independent-spatial-field-speciesspatial-copy">Independent spatial field: <code>speciesSpatial = "copy"</code></h3>
<p>Finally, we’ll implement a <code>copy</code> model, where the spatial field and its hyperparameters are estimated separately for each species. The <strong><code>"copy"</code></strong> approach can be particularly useful when you expect species to have distinct spatial patterns, but you want to ensure consistency in how these patterns are estimated across different datasets. While this gives the model the maximum amount of flexibility, it comes at the expenese of computation time – especially as the number of species greatly increases.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>speciesCopyModel <span class="ot">&lt;-</span> <span class="fu">startSpecies</span>(SetophagaData, <span class="at">Boundary =</span> PA, </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">Projection =</span> proj, <span class="at">Mesh =</span> mesh,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">responsePA =</span> <span class="st">'NPres'</span>, </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">trialsPA =</span> <span class="st">'Trials'</span>, </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">spatialCovariates =</span> covariates, </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">speciesName =</span> <span class="st">'Species_name'</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">pointsSpatial =</span> <span class="cn">NULL</span>,<span class="co"># Do not include a dataset spatial field</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">speciesSpatial =</span> <span class="st">"copy"</span>)   <span class="co"># unique spatial field per species</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Update and fit the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hyper parameters of the spatial field (shared across species)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>speciesCopyModel<span class="sc">$</span><span class="fu">specifySpatial</span>(<span class="at">Species =</span> <span class="cn">TRUE</span>,  <span class="co"># define same prior for the all species</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.1</span>),  <span class="co"># SD of field variation; P(σ &gt; σ0)</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="fl">0.1</span>))  <span class="co"># range of spatial correlation; P(ρ &lt; ρ0)</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># prior for intercept of datasets (common for all datasets and all species in the model)</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>speciesCopyModel<span class="sc">$</span><span class="fu">priorsFixed</span>(<span class="at">Effect =</span> <span class="st">'Intercept'</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mean.linear =</span> <span class="dv">0</span>, </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">prec.linear =</span> <span class="fl">0.1</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># prior for random effects (mesh nodes of spatial field and species intercepts)</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>speciesCopyModel<span class="sc">$</span><span class="fu">specifyRandom</span>(</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">speciesGroup =</span> <span class="fu">list</span>(<span class="at">model =</span> <span class="st">"iid"</span>, </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">prior =</span> <span class="st">"pc.prec"</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">param =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>)))),  <span class="co"># P(σ &gt; σ0)</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># precision parameter on the baseline species occurrence rate</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">speciesIntercepts =</span> <span class="fu">list</span>(<span class="at">prior =</span> <span class="st">'pc.prec'</span>,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>                           <span class="at">param =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>)))  <span class="co"># P(σ &gt; σ0)</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Species-specific spatial effects model</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>speciesCopyEst <span class="ot">&lt;-</span> <span class="fu">fitISDM</span>(<span class="at">data =</span> speciesCopyModel, <span class="at">options =</span> modelOptions)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="co"># View summary of the estimated model</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(speciesCopyEst)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Summary of 'modSpecies' object:

inlabru version: 2.11.1
INLA version: 24.05.10

Types of data modelled:
                                    
eBird                   Present only
BBA                  Present absence
BBS                  Present absence

Summary of the fixed effects for the species:

Summary for Setophaga_caerulescens:
                                              mean         sd 0.025quant
Setophaga_caerulescens_elevation         0.7577492 0.04847072  0.6627484
Setophaga_caerulescens_canopy            0.6067740 0.04431799  0.5199124
Setophaga_caerulescens_random_intercept -0.8106756 0.04151138 -0.8920364
                                          0.5quant 0.975quant       mode kld
Setophaga_caerulescens_elevation         0.7577492  0.8527501  0.7577492   0
Setophaga_caerulescens_canopy            0.6067740  0.6936357  0.6067740   0
Setophaga_caerulescens_random_intercept -0.8106756 -0.7293148 -0.8106756   0

Summary for Setophaga_magnolia:
                                           mean         sd 0.025quant
Setophaga_magnolia_elevation        -0.16202197 0.04299456 -0.2462898
Setophaga_magnolia_canopy           -0.07654647 0.03444367 -0.1440548
Setophaga_magnolia_random_intercept  0.81067544 0.04151138  0.7293146
                                       0.5quant   0.975quant        mode kld
Setophaga_magnolia_elevation        -0.16202197 -0.077754182 -0.16202197   0
Setophaga_magnolia_canopy           -0.07654647 -0.009038109 -0.07654647   0
Setophaga_magnolia_random_intercept  0.81067544  0.892036256  0.81067544   0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Time used:
    Pre = 1.01, Running = 7.91, Post = 0.201, Total = 9.13 
Random effects:
  Name    Model
    Setophaga_caerulescens_eBird_spatial SPDE2 model
   Species_name_intercepts IID model
   Setophaga_magnolia_eBird_spatial SPDE2 model
   Setophaga_caerulescens_BBA_spatial Copy
   Setophaga_magnolia_BBA_spatial Copy
   Setophaga_magnolia_BBS_spatial Copy
   Setophaga_caerulescens_BBS_spatial Copy

Model hyperparameters:
                                                 mean     sd 0.025quant
Range for Setophaga_caerulescens_eBird_spatial 99.653 14.589     74.606
Stdev for Setophaga_caerulescens_eBird_spatial  1.479  0.131      1.242
Precision for Species_name_intercepts          11.335  5.083      4.273
Range for Setophaga_magnolia_eBird_spatial     55.323  9.309     39.433
Stdev for Setophaga_magnolia_eBird_spatial      1.035  0.067      0.913
Beta for Setophaga_caerulescens_BBA_spatial     0.003  0.047     -0.089
Beta for Setophaga_magnolia_BBA_spatial         0.051  0.062     -0.072
Beta for Setophaga_magnolia_BBS_spatial         0.406  0.084      0.242
Beta for Setophaga_caerulescens_BBS_spatial     0.861  0.056      0.752
                                               0.5quant 0.975quant   mode
Range for Setophaga_caerulescens_eBird_spatial   98.409    131.921 95.624
Stdev for Setophaga_caerulescens_eBird_spatial    1.472      1.758  1.454
Precision for Species_name_intercepts            10.393     23.851  8.686
Range for Setophaga_magnolia_eBird_spatial       54.499     75.980 52.796
Stdev for Setophaga_magnolia_eBird_spatial        1.032      1.176  1.024
Beta for Setophaga_caerulescens_BBA_spatial       0.003      0.096  0.003
Beta for Setophaga_magnolia_BBA_spatial           0.051      0.172  0.052
Beta for Setophaga_magnolia_BBS_spatial           0.406      0.573  0.404
Beta for Setophaga_caerulescens_BBS_spatial       0.861      0.971  0.860

Deviance Information Criterion (DIC) ...............: -99199.74
Deviance Information Criterion (DIC, saturated) ....: NA
Effective number of parameters .....................: -108145.31

Watanabe-Akaike information criterion (WAIC) ...: 33549.69
Effective number of parameters .................: 10962.60

Marginal log-Likelihood:  -59212.43 
 is computed 
Posterior summaries for the linear predictor and the fitted values are computed
(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</code></pre>
</div>
</div>
<p>View results (again, only the spatial field):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># generate prediction</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>speciesCopyPredSpat <span class="ot">&lt;-</span> <span class="fu">predict</span>(speciesCopyEst,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> <span class="fu">fm_pixels</span>(<span class="at">mesh =</span> mesh,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">mask =</span> PA),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">spatial =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">n.samples =</span> <span class="dv">100</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(speciesCopyPredSpat, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">'mean'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/copy%20mod%20predict-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="species-specific-covariate-effects" class="level1">
<h1>Species-specific covariate effects</h1>
<p>In some instance, we may want to include different environmental covariates for different species. This may be desired if some covariates are only applicable for some of the species or to test competing hypotheses.</p>
<p>In our case, given the similarity of the species and the covariates we have available, there likely isn’t a good reason for including different species-specific covariates. However, just for illustration, we will fit a model where both species have an effect of elevation, but only <em>Setophaga caerulescens</em> will have an effect of canopy cover. This can be achieved by removing the <em>Setophaga caerulescens</em> canopy cover component of the model using the <code>$changeComponents()</code> slot function. We can see the components currently in the model by running <code>$changeComponents()</code> without specifying any arguments:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>speciesSpecCovModel <span class="ot">&lt;-</span> speciesModelReplicate  <span class="co"># make a copy to retain original model</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>speciesSpecCovModel<span class="sc">$</span><span class="fu">changeComponents</span>()  <span class="co"># view available components</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model components:
~-1 + speciesShared(main = geometry, model = speciesField, group = speciesSpatialGroup, 
    control.group = list(model = "iid", hyper = list(prec = list(prior = "pc.prec", 
        param = c(0.1, 0.1))))) + Setophaga_caerulescens_elevation(main = Setophaga_caerulescens_elevation, 
    model = "linear") + Setophaga_magnolia_elevation(main = Setophaga_magnolia_elevation, 
    model = "linear") + Setophaga_caerulescens_canopy(main = Setophaga_caerulescens_canopy, 
    model = "linear") + Setophaga_magnolia_canopy(main = Setophaga_magnolia_canopy, 
    model = "linear") + Species_name_intercepts(main = Species_name, 
    model = "iid", constr = TRUE, hyper = list(prec = list(prior = "pc.prec", 
        param = c(0.1, 0.1)))) + eBird_intercept(1, mean.linear = 0, 
    prec.linear = 0.1) + BBA_intercept(1, mean.linear = 0, prec.linear = 0.1) + 
    BBS_intercept(1, mean.linear = 0, prec.linear = 0.1)
&lt;environment: 0x000002e4c7586b38&gt;</code></pre>
</div>
</div>
<p>Now, we can remove any components that we don’t want to include in the model – in this case the effect of canopy cover on on <em>Setophaga magnolia</em>, which we can see from above has been named <code>Setophaga_magnolia_canopy()</code>. We can remove this component by defining it as the <code>removeComponent</code> argument in <code>$changeComponents()</code> as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>speciesSpecCovModel<span class="sc">$</span><span class="fu">changeComponents</span>(<span class="at">removeComponent =</span> <span class="st">"Setophaga_magnolia_canopy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model components:
~-1 + speciesShared(main = geometry, model = speciesField, group = speciesSpatialGroup, 
    control.group = list(model = "iid", hyper = list(prec = list(prior = "pc.prec", 
        param = c(0.1, 0.1))))) + Setophaga_caerulescens_elevation(main = Setophaga_caerulescens_elevation, 
    model = "linear") + Setophaga_magnolia_elevation(main = Setophaga_magnolia_elevation, 
    model = "linear") + Setophaga_caerulescens_canopy(main = Setophaga_caerulescens_canopy, 
    model = "linear") + Species_name_intercepts(main = Species_name, 
    model = "iid", constr = TRUE, hyper = list(prec = list(prior = "pc.prec", 
        param = c(0.1, 0.1)))) + eBird_intercept(1, mean.linear = 0, 
    prec.linear = 0.1) + BBA_intercept(1, mean.linear = 0, prec.linear = 0.1) + 
    BBS_intercept(1, mean.linear = 0, prec.linear = 0.1)
&lt;environment: 0x000002e4c957ca50&gt;</code></pre>
</div>
</div>
<p>You should see above that the <code>Setophaga_magnolia_canopy</code> component has been removed from the model.</p>
<p>As we are using the previously defined <code>speciesModelReplicate</code> model, the priors are already specified in the model, so we can simply fit it and examine the results:</p>
<pre class="{rspecies-spec fit}"><code># Fit the model
speciesSpecCovEst &lt;- fitISDM(data = speciesSpecCovModel, 
                             options = modelOptions)

# Examine the results
summary(speciesSpecCovEst)</code></pre>
<p>Pay particular attention to the coefficients for the canopy cover. You should see effects for <em>S. caerulescens</em> but not for <em>S. magnoli</em>.</p>
<p>This approach allows us to incorporate species-specific ecological knowledge into our multispecies model, potentially improving its biological realism and predictive power while reducing overfitting by leveraging prior knowledge.</p>
</section>
<section id="bias-correction" class="level1">
<h1>Bias Correction</h1>
<p>As in the previous vignette, we can estimate a bias field for datasets that may have significant bias such as eBird. The estimation of this should be significantly better in the multispecies model compared to the independent models as we are leveraging observations across species to estimate a common bias field. As before, the dataset bias field can be specified using the <code>$addBias()</code> slot function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add bias field to eBird data</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>speciesModelReplicate<span class="sc">$</span><span class="fu">addBias</span>(<span class="at">datasetNames =</span> <span class="st">'eBird'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Turning copyModel off since the number of datasets specified is less than 2.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>speciesModelReplicate<span class="sc">$</span><span class="fu">specifySpatial</span>(<span class="at">Bias =</span> <span class="cn">TRUE</span>, </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">prior.sigma =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">prior.range =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="fl">0.1</span>))</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model with bias correction</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>biasEst <span class="ot">&lt;-</span> <span class="fu">fitISDM</span>(<span class="at">data =</span> speciesModelReplicate, <span class="at">options =</span> modelOptions)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Make predictions</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>BiaspredSpatial <span class="ot">&lt;-</span> <span class="fu">predict</span>(biasEst,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">data =</span> <span class="fu">fm_pixels</span>(<span class="at">mesh =</span> mesh, <span class="at">mask =</span> PA),</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>                           <span class="at">spatial =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n.samples =</span> <span class="dv">100</span>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare predictions</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(speciesReplicatePredSpat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/bias%20mod%20specify%20&amp;%20fit%20&amp;%20pred%20spat-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(BiaspredSpatial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/bias%20mod%20specify%20&amp;%20fit%20&amp;%20pred%20spat-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These plots allow us to compare predictions with and without bias correction. Look for areas where the predictions differ significantly, as these may indicate regions where sampling bias has a strong influence on the model.</p>
<p>We expect the citizen science data (i.e., eBird) to be highly correlated with population density. We can check whether the model identified that pattern by predicting the estimated bias field alone using the argument <code>bias = TRUE</code> in the <code>predict</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># predict just the bias field</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>biasPredBias <span class="ot">&lt;-</span> <span class="fu">predict</span>(biasEst,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> <span class="fu">fm_pixels</span>(<span class="at">mesh =</span> mesh, <span class="at">mask =</span> PA),</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">bias =</span> <span class="cn">TRUE</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">n.samples =</span> <span class="dv">100</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co"># generate map of the estimated eBird dataset bias</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>plot_eBird_bias <span class="ot">&lt;-</span> <span class="fu">plot</span>(biasPredBias) <span class="sc">+</span> </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Prediction of mean for</span><span class="sc">\n</span><span class="st">eBird_biasField bias field"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/bias%20mod%20pred%20bias-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now, we will import population density data downloaded plot/compare this with the estimated eBird bias.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>pa_pop <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">here</span>(<span class="st">"Data/Vignette_setophaga/PA_pop_density.shp"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `PA_pop_density' from data source 
  `C:\Users\RonTogunov\Research\PointedSDMs_Workshop\Data\Vignette_setophaga\PA_pop_density.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 3218 features and 7 fields (with 1 geometry empty)
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -80.51989 ymin: 39.7198 xmax: -74.68952 ymax: 42.26986
Geodetic CRS:  NAD83</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># map log population density</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>plot_pap_pop <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pa_pop) <span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> density), <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">trans =</span> <span class="st">"log"</span>,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Population/nper sq km"</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span> </span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Population density"</span>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co"># plot together</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>plot_eBird_bias <span class="sc">+</span> plot_pap_pop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in scale_fill_gradientn(colours = viridisLite::viridis(256, alpha, :
log-2.718282 transformation introduced infinite values.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/bias%20mod%20plot%20bias%20&amp;%20popden-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This plot shows the estimated spatial pattern of bias in the eBird data. Areas with higher values indicate regions where eBird data might over represent species occurrences due to increased sampling effort or other biases. By comparing these plots, we can see how well the estimated bias field corresponds to human population density. This can help validate our bias correction and provide insights into the spatial patterns of sampling effort in citizen science data.</p>
</section>
<section id="supplementary-activities" class="level1">
<h1>Supplementary activities</h1>
<p>In this workshop, we’ve explored various ways of specifying multispecies models, sharing different parts of the spatial field or covariates, estimating sampling biases, and generating different predictions maps. The following supplementary activities explore some of these themes in greater depth.</p>
<section id="compare-models-predict-distribution" class="level2">
<h2 class="anchored" data-anchor-id="compare-models-predict-distribution">Compare models Predict distribution</h2>
<p>Given the many ways of specifying models for the same data, we may need to test competing models to identify the most parsimonious ones. This can be done using the model deviance information criterion (<strong>DIC</strong>). DIC is often preferred over Akaike information criterion (AIC) in Bayesian hierarchical models as it also accounts for the posterior distribution of the parameters. Similar to AIC, lower values are better – the common rule of thumb that a difference (<span class="math inline">\(\delta\)</span>DIC) of &lt;2 is considered indicating minimal evidence that the model with lower DIC is better, <span class="math inline">\(\delta\)</span>DIC 2-5 suggests moderate evidence, and <span class="math inline">\(\delta\)</span>DIC &gt;5 is considered substantial evidence. We can extract a fitted model’s DIC as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare models</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>speciesSharedEst<span class="sc">$</span>dic<span class="sc">$</span>dic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -95628.03</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>speciesReplicateEst<span class="sc">$</span>dic<span class="sc">$</span>dic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -97462.28</code></pre>
</div>
</div>
<p>Importantly, we can only compare DIC values for models with the same observation data and the same mesh.</p>
<p>Can you extract the DIC values for the other fitted models? Which model is preferred and why?</p>
</section>
<section id="model-predictions" class="level2">
<h2 class="anchored" data-anchor-id="model-predictions">Model predictions</h2>
<p>In the <strong>Examining Species-Specific Responses</strong> section of the <strong>Shared spatial effect</strong> model, we predicted and mapped the combined covariate effects by specifying all the covariates for the argument <code>covariates = speciesSharedEst$spatCovs$name</code>. If we define the <code>covariates</code> argument as any subset of the used spatial covariates, we can explore any specific covariates effects separately as desired. Can you modify the following code to predict effect of one of the covariates in one of the models?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>fittedModel <span class="ot">&lt;-</span> ???</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  modelPred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fittedModel,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> <span class="fu">fm_pixels</span>(<span class="at">mesh =</span> mesh, <span class="at">mask =</span> PA),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">spatial =</span> <span class="cn">FALSE</span>,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">covariates =</span> ???,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">n.samples =</span> <span class="dv">100</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(modelPred, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">'mean'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mesh-specification-and-covariate-interpolation" class="level2">
<h2 class="anchored" data-anchor-id="mesh-specification-and-covariate-interpolation">Mesh specification and covariate interpolation</h2>
<p>The definition of a mesh can have a big effect on model performance. Most importantly, the scale and resolution of the mesh need to be fine enough to capture the variation and structure in the distribution of the focal species. In addition to this, if you have presence-only data, it also needs to be fine enough to capture the structure and variation of the spatial covariates. This is because from the perspective of the model, it only ‘sees’ the covariates at the observed points and the mesh nodes, and it is assumed that all locations between mesh nodes can be approximated using linear interpolation. If the heterogeneity of the covariates occur at a significantly finer scale than the mesh nodes, there could be a significant mismatch between the true covariate map and the one assumed by the model. Therefore, it’s crucial to understand how our environmental covariates are represented across the study area and how they appear through the mesh.</p>
<p>The following code creates visualizations of our elevation and canopy cover data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariate raster aggregation</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>aggregationFactor <span class="ot">&lt;-</span> <span class="dv">1</span>  </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define mesh</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>testMesh <span class="ot">&lt;-</span> <span class="fu">inla.mesh.2d</span>(<span class="at">boundary =</span> <span class="fu">inla.sp2segment</span>(PA), </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">max.edge =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">1.24</span>) <span class="sc">*</span> <span class="dv">40</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cutoff =</span> <span class="dv">10</span> <span class="sc">*</span> <span class="dv">10</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">offset =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.4</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">crs =</span> <span class="fu">st_crs</span>(proj))</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="do">## extract and interpolate covariates</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># project covs to project proj</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  covs <span class="ot">&lt;-</span> <span class="fu">project</span>(<span class="fu">aggregate</span>(covariates, <span class="at">fact =</span> aggregationFactor, <span class="at">fun=</span><span class="st">"mean"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), proj)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract mesh vertices</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  vertices <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(testMesh<span class="sc">$</span>loc[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(vertices) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assuming your covariates are stored in a SpatRaster object named `covariates`</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  elevation_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(covs[[<span class="st">"elevation"</span>]], vertices)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  canopy_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(covs[[<span class="st">"canopy"</span>]], vertices)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine the vertex coordinates with the extracted values</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  vertices<span class="sc">$</span>elevation <span class="ot">&lt;-</span> elevation_values[, <span class="dv">2</span>]</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  vertices<span class="sc">$</span>canopy <span class="ot">&lt;-</span> canopy_values[, <span class="dv">2</span>]</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert vertices to an sf object</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>  vertices_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(vertices, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="fu">st_crs</span>(covariates))</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the triangles of the mesh</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>  triangles <span class="ot">&lt;-</span> testMesh<span class="sc">$</span>graph<span class="sc">$</span>tv</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a grid of points over the study area for interpolation</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  ext <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(covs)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>  centers <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="fu">seq</span>(ext[<span class="dv">1</span>], ext[<span class="dv">2</span>],<span class="at">length.out=</span> <span class="dv">200</span>),<span class="fu">seq</span>(ext[<span class="dv">3</span>], ext[<span class="dv">4</span>],<span class="at">length.out=</span> <span class="dv">100</span>)) </span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(centers) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'x'</span>,<span class="st">'y'</span>)</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to data.frame</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>  centers_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(centers)</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to sf object</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>  study_area <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(centers_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="fu">crs</span>(covs)) <span class="sc">%&gt;%</span> </span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># remove points outside of shape</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_crop</span>(PA)</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>  grid_points <span class="ot">&lt;-</span> <span class="fu">st_coordinates</span>(study_area) </span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># replace NAs</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>  vertices<span class="sc">$</span>elevation[<span class="fu">is.na</span>(vertices<span class="sc">$</span>elevation)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>  vertices<span class="sc">$</span>canopy[<span class="fu">is.na</span>(vertices<span class="sc">$</span>canopy)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>  <span class="do">##2D barycentric interpolation at points Xi for a function with values f measured at locations X</span></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">#For N-D interpolation simply replace tsearch with tsearchn and modify the sparse matrix definition to have non-zero values in the right spots.</span></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>  interp.barycentric <span class="ot">&lt;-</span> <span class="cf">function</span>(X,f,Xi){</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>    dn <span class="ot">&lt;-</span> <span class="fu">delaunayn</span>(X)</span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>    tri <span class="ot">&lt;-</span> <span class="fu">tsearch</span>(X[,<span class="dv">1</span>],X[,<span class="dv">2</span>],dn,Xi[,<span class="dv">1</span>],Xi[,<span class="dv">2</span>],<span class="at">bary=</span>T)</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">#For each line in Xi, defines which points in X contribute to the interpolation</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>    active <span class="ot">&lt;-</span> dn[tri<span class="sc">$</span>idx,]</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter out NAs from tri$idx and active</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>    valid_idx <span class="ot">&lt;-</span> <span class="fu">is.na</span>(tri<span class="sc">$</span>idx)</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>    active[valid_idx, ] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>    tri<span class="sc">$</span>p[valid_idx, ] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the interpolation as a sparse matrix operation</span></span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>    M <span class="ot">&lt;-</span> <span class="fu">sparseMatrix</span>(<span class="at">i =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(Xi), <span class="at">each =</span> <span class="dv">3</span>), <span class="at">j =</span> <span class="fu">as.numeric</span>(<span class="fu">t</span>(active)), <span class="at">x =</span> <span class="fu">as.numeric</span>(<span class="fu">t</span>(tri<span class="sc">$</span>p)), <span class="at">dims =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(Xi), <span class="fu">length</span>(f)))</span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>(M <span class="sc">%*%</span> f)</span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Interpolate elevation values</span></span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>  interpolated_elevation <span class="ot">&lt;-</span> <span class="fu">interp.barycentric</span>(<span class="fu">as.matrix</span>(vertices[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)]), vertices<span class="sc">$</span>elevation, grid_points)</span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Interpolate canopy values</span></span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>  interpolated_canopy <span class="ot">&lt;-</span> <span class="fu">interp.barycentric</span>(<span class="fu">as.matrix</span>(vertices[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)]), vertices<span class="sc">$</span>canopy, grid_points)</span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine the interpolated points with the values</span></span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>  interpolated_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> grid_points[, <span class="dv">1</span>],</span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> grid_points[, <span class="dv">2</span>],</span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">elevation =</span> interpolated_elevation,</span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">canopy =</span> interpolated_canopy</span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to sf object</span></span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>  interpolated_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(interpolated_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">crs =</span> <span class="fu">st_crs</span>(covariates))</span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: [aggregate] all values in argument 'fact' are 1, nothing to do</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="do">## plot interpolated covariates</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot observed &amp; interpolated elevation</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  p1obs <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_spatraster</span>(<span class="at">data =</span> covs<span class="sc">$</span>elevation) <span class="sc">+</span> </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Observed Elevation"</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  p1int <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(interpolated_df) <span class="sc">+</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> elevation)) <span class="sc">+</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Interpolated Elevation"</span>, <span class="at">fill =</span> <span class="st">"Elevation"</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot observed &amp; interpolated canopy </span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  p2obs <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_spatraster</span>(<span class="at">data =</span> covs<span class="sc">$</span>canopy) <span class="sc">+</span> </span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Observed Canopy"</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  p2int <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(interpolated_df) <span class="sc">+</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> canopy)) <span class="sc">+</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Interpolated Canopy"</span>, <span class="at">fill =</span> <span class="st">"Canopy"</span>)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Display plots side by side</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>p1obs <span class="sc">+</span> p1int <span class="sc">+</span> </span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>  p2obs <span class="sc">+</span> p2int <span class="sc">&amp;</span> </span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="SetophagaExercise3_files/figure-html/visualise%20cov%20interpolation-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plots on the left are the covariates as inputted in the model, and the plots on the right show the covariates as linearly interpolated via the mesh. Ideally, we want the interpolated mesh to resemble the observed covariates. From the initial fit, we can see that elevation is somewhat accurately reflected, however, due to the greater degree of spatial variation in the canopy cover, there is a bigger mismatch with the interpolated values. There are two ways to try to improve this. First, we can increase the resolution of the mesh by decreasing the first value of the <code>max.edge</code> argument in <code>inla.mesh.2d()</code>. Unfortunately, this finer mesh can drastically increase the computation time, and may be overkill if it is already finer than the spatial structure of the species intensity. The second option is to decrease the resolution of the covariates using <code>terra::aggregate()</code>; the <code>fact</code> argument represents the number of cells in each direction (horizontally and vertically) that are summarised together using the function defined by the <code>fun</code> argument (<code>"mean"</code> in the code above). Experiment with changing the mesh resolution and raster aggregation to see the effect on the interpolated covariates.</p>
<p>These visualizations help us understand the spatial patterns of our environmental covariates and how well they’re represented by our mesh structure. This is important because the accuracy of our species distribution predictions will depend partly on how well we capture environmental variation across the landscape.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>